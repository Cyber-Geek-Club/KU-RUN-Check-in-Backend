name: Deploy to Windows Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted  # สำคัญ: สั่งให้รันบนเครื่อง Windows ของคุณเอง
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Update Code and Restart Service
      shell: powershell
      run: |
        # 1. เข้าไปที่โฟลเดอร์โปรเจกต์ (GitHub Runner จะ checkout โค้ดมาที่โฟลเดอร์ work ของมันเอง)
        # แต่ถ้าคุณรัน Production แยกโฟลเดอร์ ให้สั่ง copy หรือ git pull ไปที่โฟลเดอร์นั้น
        
        $PROJECT_PATH = "C:\ku-run-backend"
        
        Write-Host "Deploying to $PROJECT_PATH..."
        
        # เปลี่ยนไปที่โฟลเดอร์งานจริง
        cd $PROJECT_PATH
        
        # ดึงโค้ดล่าสุด
        git pull origin main
        
        # อัปเดต Library
        .\venv\Scripts\pip install -r requirements.txt
        
        # รีสตาร์ท Service (ต้องรัน Runner ด้วยสิทธิ์ Admin ถึงจะสั่ง restart ได้)
        # หรือใช้ nssm restart ก็ได้
        nssm restart KURunBackend
        
        Write-Host "Deployment Complete!"