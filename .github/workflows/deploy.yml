name: Deploy to Windows VPS

on:
  push:
    branches: [ "main" ]  # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡πÄ‡∏Ç‡πâ‡∏≤ branch main

jobs:
  deploy:
    runs-on: self-hosted  # ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Server ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏µ Runner
    
    steps:
    - name: Checkout Code (For Log)
      uses: actions/checkout@v4
      # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö GitHub ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á Deploy Commit ‡πÑ‡∏´‡∏ô

    - name: Deploy Script
      shell: powershell
      run: |
        # ================= CONFIG =================
        # ‡∏£‡∏∞‡∏ö‡∏∏ Path ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏ô Server
        $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Backend"
        $SERVICE_NAME = "KURunService.exe"  # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå WinSW ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
        # ==========================================

        Write-Host "üöÄ Starting Deployment to $PROJECT_PATH..."

        # 1. ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏á‡∏≤‡∏ô
        cd $PROJECT_PATH

        # 2. ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        Write-Host "üì• Pulling latest code..."
        git fetch origin main
        git reset --hard origin/main  
        # ‡πÉ‡∏ä‡πâ reset --hard ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö GitHub (‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏™‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢)
        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏Å‡πâ‡∏™‡∏î‡∏´‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ git pull origin main ‡πÅ‡∏ó‡∏ô

        # 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Library
        Write-Host "üì¶ Installing dependencies..."
        .\venv\Scripts\pip install -r requirements.txt

        # 4. ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó Service
        Write-Host "üîÑ Restarting Service..."
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Service ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡πá Start ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏Å‡πá Restart
        try {
            & ".\$SERVICE_NAME" restart
        } catch {
            Write-Host "‚ö†Ô∏è Service might not be installed or running. Trying to start..."
            & ".\$SERVICE_NAME" start
        }

        # 5. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        & ".\$SERVICE_NAME" status
        Write-Host "‚úÖ Deployment Complete!"
        