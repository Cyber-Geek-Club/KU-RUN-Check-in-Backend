name: Deploy to Windows VPS with Docker

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Deploy with Docker Compose
        shell: powershell
        run: |
          # ================= CONFIG =================
          $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Backend"
          # ==========================================

          Write-Host "Starting Docker Deployment to $PROJECT_PATH..."

          # 1. Go to project directory
          cd $PROJECT_PATH

          # 2. Pull latest code
          Write-Host "Pulling latest code..."
          git fetch origin master
          
          # Force reset to match GitHub (Be careful: local changes will be lost)
          git reset --hard origin/master

          # 3. Check if .env exists, if not copy from template
          if (-not (Test-Path ".env")) {
              Write-Host "Creating .env from template..."
              Copy-Item ".env.docker" ".env"
              Write-Warning "Please update .env with correct database credentials!"
          }

          # 4. Build and restart Docker containers
          Write-Host "Building and starting Docker containers..."
          docker-compose down
          docker-compose build --no-cache
          docker-compose up -d

          # 5. Wait for containers to be healthy
          Write-Host "Waiting for containers to start..."
          Start-Sleep -Seconds 10

          # 6. Check container status
          Write-Host "Container Status:"
          docker-compose ps

          # 7. Health check
          Write-Host "Running health check..."
          try {
              $response = Invoke-RestMethod -Uri "http://localhost:8005/health" -Method Get -TimeoutSec 10
              Write-Host "Health check passed: $($response | ConvertTo-Json)"
          } catch {
              Write-Warning "Health check failed: $_"
          }

          Write-Host "Docker Deployment Complete!"