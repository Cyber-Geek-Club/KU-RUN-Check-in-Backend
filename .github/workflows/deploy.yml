name: Deploy to Windows VPS

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Deploy Script
        shell: powershell
        run: |
          # ================= CONFIG =================
          $PROJECT_PATH = "C:\Users\Administrator\Desktop\Web Project\KU-run\KU-RUN-Check-in-Backend"
          $SERVICE_EXE = "KURunService.exe"
          # ==========================================

          Write-Host "Starting Deployment to $PROJECT_PATH..."

          # 1. Go to project directory
          cd $PROJECT_PATH

          # 2. Pull latest code
          Write-Host "Pulling latest code..."
          git fetch origin master
          
          # Force reset to match GitHub (Be careful: local changes will be lost)
          git reset --hard origin/master

          # 3. Update dependencies
          if (Test-Path "env\Scripts\pip.exe") {
              Write-Host "Installing dependencies..."
              .\env\Scripts\pip install -r requirements.txt
          }

          # 4. Restart Service
          Write-Host "Restarting Service..."
          if (Test-Path $SERVICE_EXE) {
              & ".\$SERVICE_EXE" restart
              
              Start-Sleep -Seconds 3
              & ".\$SERVICE_EXE" status
          } else {
              Write-Error "Service file not found: $SERVICE_EXE"
          }

          Write-Host "Deployment Complete!"